\begin{figure}[H!]
\center
\begin{tikzpicture}[
  dep/.style ={
    ->,line width=0.3mm
  },
  hid/.style 2 args={
    rectangle split,
    draw=#2,
    rectangle split parts=#1,
    fill=#2!20,
    minimum width=5mm,
    minimum height=5mm,
    outer sep=2mm},
  mlp/.style 2 args={
    rectangle split,
    rectangle split horizontal,
    draw=#2,
    rectangle split parts=#1,
    fill=#2!20,
    outer sep=2mm},
  sal/.style={
    circle, 
    minimum width=8mm,
    outer sep=2mm,
    draw=#1, 
    fill=#1!20},
]

  \def\stepsize{1.5}%
  \def\lvlbase{0}%
  \def\lvlheight{3}%
 

    % Sentence Embeddings    
  \foreach \step in {1,...,3} {
    \node[hid={3}{sentemb}] (s\step) at (\stepsize*\step, \lvlbase) {};    
    \node at (\stepsize*\step, \lvlbase) {$\sentEmb_\step$};    
   }
%    % RNN hidden states
    \foreach \step in {1,...,3} {
        \node[hid={3}{encemb}] (rrnn_\step) 
            at (\stepsize *\step-0.5, \lvlbase + \lvlheight) {};    
        \node at (\stepsize *\step-0.5, \lvlbase + \lvlheight) 
            {$\rnnextRHid_\step$}; 
        \node[hid={3}{yellow}] (lrnn_\step) 
            at (\stepsize *\step+0.5, \lvlbase + \lvlheight + 1.0) {};    
        \node at (\stepsize *\step+0.5, \lvlbase + \lvlheight+ 1.0) 
            {$\rnnextLHid_\step$}; 
        \draw[dep] (s\step.north) -- (rrnn_\step.south);
        \draw[dep] (s\step.north) -- (lrnn_\step.south);


%        \node[hid={3}{orange}] (ctx_\step) 
%            at (\stepsize *\step, \lvlbase + 2.25*\lvlheight) {};    
%        \node at (\stepsize *\step, \lvlbase + 2.25*\lvlheight) 
%            {$\rnnextHid_\step$}; 
%        \draw[dep] (rrnn_\step.north) -- (ctx_\step.south);
%        \draw[dep] (lrnn_\step.north) -- (ctx_\step.south);
%
%
%        \node[sal={blue}] (sal_\step) 
%            at (\stepsize *\step, \lvlbase + 3*\lvlheight) {};    
%        \node at (\stepsize *\step, \lvlbase + 3*\lvlheight) 
%            {$\bsal_i$}; 
%        \draw[dep] (ctx_\step.north) -- (sal_\step.south);
        %\draw[dep] (lrnn_\step.north) -- (ctx_\step.south);


    }
  \def\stepsize{1.5}%
  \def\lvlbase{0}%
  \def\lvlheight{3}%
 

    \foreach \step in {1,...,3} {
        \node[hid={3}{yellow}] (rrnn_\step) 
            at (\stepsize *\step-0.35 + 5, \lvlbase + 0*\lvlheight) {};    
        \node at (\stepsize*\step-0.35 + 5, \lvlbase + 0*\lvlheight) 
            {$\rnnextRHid_\step$}; 
        \node[hid={3}{yellow}] (lrnn_\step) 
            at (\stepsize *\step+5.35, \lvlbase + 0*\lvlheight + 0.5) {};    
        \node at (\stepsize *\step+5.35, \lvlbase + 0*\lvlheight+ 0.5) 
            {$\rnnextLHid_\step$}; 
    }

    \foreach \step in {1,...,3} {
        \node[hid={3}{yellow}] (rrnn_\step) 
            at (\stepsize *\step-0.35 + 10, \lvlbase + 0*\lvlheight) {};    
        \node at (\stepsize*\step-0.35 + 10, \lvlbase + 0*\lvlheight) 
            {$\rnnextRHid_\step$}; 
        \node[hid={3}{yellow}] (lrnn_\step) 
            at (\stepsize *\step+10.35, \lvlbase + 0*\lvlheight + 0.5) {};    
        \node at (\stepsize *\step+10.35, \lvlbase + 0*\lvlheight+ 0.5) 
            {$\rnnextLHid_\step$}; 
    }

    \foreach \step in {1,...,3} {
        \node[hid={3}{yellow}] (ctx_\step) 
            at (\stepsize *\step + 5, \lvlbase + 1*\lvlheight) {};    
        \node at (\stepsize*\step + 5, \lvlbase + 1*\lvlheight) 
            {$\srHid_\step$}; 
    }

        \node[hid={3}{yellow}] (doc) 
            at (\stepsize *2 + 10, \lvlbase + 1*\lvlheight) {};    
        \node at (\stepsize*2 + 10, \lvlbase + 1*\lvlheight) 
            {$\srDocEmb$}; 


        \node[hid={3}{yellow}] (ctx_i) 
            at (\stepsize *1 , \lvlbase + -2*\lvlheight) {};    
        \node at (\stepsize*1, \lvlbase + -2*\lvlheight) 
            {$\srHid_i$}; 

        \node[hid={1}{yellow}] (content_i) 
            at (\stepsize *1, \lvlbase + -1*\lvlheight) {};    
        \node at (\stepsize*1, \lvlbase + -1*\lvlheight) 
            {$\srContentFactor_i$}; 

        \node[hid={3}{yellow}] (ctx_i) 
            at (\stepsize *3 , \lvlbase + -2*\lvlheight) {};    
        \node at (\stepsize*3, \lvlbase + -2*\lvlheight) 
            {$\srHid_i$}; 

        \node[hid={1}{yellow}] (salience_i) 
            at (\stepsize *3.5, \lvlbase + -1*\lvlheight) {};    
        \node at (\stepsize*3.5, \lvlbase + -1*\lvlheight) 
            {$\srSalienceFactor_i$}; 
        \node[hid={3}{yellow}] (doc) 
            at (\stepsize *4, \lvlbase + -2*\lvlheight) {};    
        \node at (\stepsize*4, \lvlbase + -2*\lvlheight) 
            {$\srDocEmb$}; 

        \node[hid={3}{yellow}] (ctx_i) 
            at (\stepsize *6 , \lvlbase + -2*\lvlheight) {};    
        \node at (\stepsize*6, \lvlbase + -2*\lvlheight) 
            {$\srHid_i$}; 

        \node[hid={1}{yellow}] (finepos_i) 
            at (\stepsize *6, \lvlbase + -1*\lvlheight) {};    
        \node at (\stepsize*6, \lvlbase + -1*\lvlheight) 
            {$\srFinePositionFactor_i$}; 

        \node[hid={3}{yellow}] (ctx_i) 
            at (\stepsize *8 , \lvlbase + -2*\lvlheight) {};    
        \node at (\stepsize*8, \lvlbase + -2*\lvlheight) 
            {$\srHid_i$}; 
        \node[hid={1}{yellow}] (coarsepos_i) 
            at (\stepsize *8, \lvlbase + -1*\lvlheight) {};    
        \node at (\stepsize*8, \lvlbase + -1*\lvlheight) 
            {$\srCoarsePositionFactor_i$}; 

    %    \node[hid={3}{yellow}] (ctx_i) 
    %        at (\stepsize *1 , \lvlbase + -5*\lvlheight) {};    
    %    \node at (\stepsize*1, \lvlbase + -5*\lvlheight) 
    %        {$\srHid_i$}; 

        \node[hid={3}{green}] (summary_1) 
            at (\stepsize *1 , \lvlbase + -4*\lvlheight) {};    
        \node at (\stepsize*1, \lvlbase + -4*\lvlheight) 
            {$\srSum_1$}; 

        \node[hid={3}{yellow}] (ctx_1) 
            at (\stepsize *2 , \lvlbase + -4*\lvlheight) {};    
        \node at (\stepsize*2, \lvlbase + -4*\lvlheight) 
            {$\srHid_1$}; 

            \node[hid={1}{red}] (salience_1) 
            at (\stepsize *2 , \lvlbase + -3*\lvlheight) {};    
        \node at (\stepsize*2, \lvlbase + -3*\lvlheight) 
            {$\srSalienceFactor_1$}; 


        \draw[dep] (summary_1.north) to (salience_1.south);
        \draw[dep] (ctx_1.north) to (salience_1.south);


        \node[hid={3}{yellow}] (ctx_1) 
            at (\stepsize *3 , \lvlbase + -5*\lvlheight) {};    
        \node at (\stepsize*3, \lvlbase + -5*\lvlheight) 
            {$\srHid_1$}; 

        \node[sal={blue}] (p_1) 
            at (\stepsize *4 , \lvlbase + -5*\lvlheight) {};    
        \node at (\stepsize*4, \lvlbase + -5*\lvlheight) 
            {$\bsal_1$}; 

        \node[hid={3}{green}] (summary_2) 
            at (\stepsize *4 , \lvlbase + -4*\lvlheight) {};    
        \node at (\stepsize*4, \lvlbase + -4*\lvlheight) 
            {$\srSum_2$}; 

        \node[hid={3}{yellow}] (ctx_2) 
            at (\stepsize *5 , \lvlbase + -4*\lvlheight) {};    
        \node at (\stepsize*5, \lvlbase + -4*\lvlheight) 
            {$\srHid_2$}; 

            \node[hid={1}{red}] (salience_2) 
            at (\stepsize *5 , \lvlbase + -3*\lvlheight) {};    
        \node at (\stepsize*5, \lvlbase + -3*\lvlheight) 
            {$\srSalienceFactor_2$}; 


        \draw[dep] (summary_2.north) to (salience_2.south);
        \draw[dep] (ctx_2.north) to (salience_2.south);


        \draw[dep] (ctx_1.north) to (summary_2.south);
        \draw[dep] (p_1.north) to (summary_2.south);








        \node[hid={3}{yellow}] (ctx_1) 
            at (\stepsize *6 , \lvlbase + -5*\lvlheight) {};    
        \node at (\stepsize*6, \lvlbase + -5*\lvlheight) 
            {$\srHid_1$}; 

        \node[sal={blue}] (p_1) 
            at (\stepsize *7 , \lvlbase + -5*\lvlheight) {};    
        \node at (\stepsize*7, \lvlbase + -5*\lvlheight) 
            {$\bsal_1$}; 

        \node[hid={3}{yellow}] (ctx_2) 
            at (\stepsize *8 , \lvlbase + -5*\lvlheight) {};    
        \node at (\stepsize*8, \lvlbase + -5*\lvlheight) 
            {$\srHid_2$}; 

        \node[sal={blue}] (p_2) 
            at (\stepsize *9 , \lvlbase + -5*\lvlheight) {};    
        \node at (\stepsize*9, \lvlbase + -5*\lvlheight) 
            {$\bsal_2$}; 



        \node[hid={3}{green}] (summary_3) 
            at (\stepsize *9 , \lvlbase + -4*\lvlheight) {};    
        \node at (\stepsize*9, \lvlbase + -4*\lvlheight) 
            {$\srSum_3$}; 

        \node[hid={3}{yellow}] (ctx_3) 
            at (\stepsize *10 , \lvlbase + -4*\lvlheight) {};    
        \node at (\stepsize*10, \lvlbase + -4*\lvlheight) 
            {$\srHid_3$}; 

            \node[hid={1}{red}] (salience_3) 
            at (\stepsize *10 , \lvlbase + -3*\lvlheight) {};    
        \node at (\stepsize*10, \lvlbase + -3*\lvlheight) 
            {$\srSalienceFactor_3$}; 


        \draw[dep] (ctx_1.north) to (summary_3.south);
        \draw[dep] (p_1.north) to (summary_3.south);

        \draw[dep] (ctx_2.north) to (summary_3.south);
        \draw[dep] (p_2.north) to (summary_3.south);

        \draw[dep] (summary_3.north) to (salience_3.south);
        \draw[dep] (ctx_3.north) to (salience_3.south);













%        \node[hid={3}{yellow}] (ctx_1) 
%            at (\stepsize *4 , \lvlbase + -5*\lvlheight) {};    
%        \node at (\stepsize*4, \lvlbase + -5*\lvlheight) 
%            {$\srHid_1$}; 
%        \node[hid={3}{yellow}] (ctx_2) 
%            at (\stepsize *5 , \lvlbase + -5*\lvlheight) {};    
%        \node at (\stepsize*5, \lvlbase + -5*\lvlheight) 
%            {$\srHid_2$}; 
%
%
%

%    \foreach \start [count=\stop from 2] in {1,...,2} {
%        \draw[dep] ($ (rrnn_\start.east) - (0,0.3)$) 
%            -- ($ (rrnn_\stop.west) - (0,0.3) $);
%        \draw[dep] ($(lrnn_\stop.west) + (0,0.3)$) 
%            -- ($ (lrnn_\start.east) + (0,0.3)   $);
%    }

%    \draw[rectangle,draw=black,dotted] 
%        (\stepsize*-2.5,\lvlbase + 3.5*\lvlheight) -- 
%        (\stepsize*3.5, \lvlbase + 3.5*\lvlheight) -- 
%        (\stepsize*3.5, \lvlbase + 2.7*\lvlheight) --
%        (\stepsize*-2.5, \lvlbase + 2.7*\lvlheight) --
%        (\stepsize*-2.5, \lvlbase + 3.5*\lvlheight) ;
%
%    \node[align=left,anchor=north west] 
%        at (\stepsize * -2.5,\lvlbase + 3.5*\lvlheight) 
%        {\textit{Salience Estimates}};
%
%    \draw[rectangle,draw=black,dotted] 
%        (\stepsize*-2.5,\lvlbase + 2.6*\lvlheight) -- 
%        (\stepsize*3.5, \lvlbase + 2.6*\lvlheight) -- 
%        (\stepsize*3.5, \lvlbase + 1.8*\lvlheight) --
%        (\stepsize*-2.5, \lvlbase + 1.8*\lvlheight) --
%        (\stepsize*-2.5, \lvlbase + 2.6*\lvlheight) ;
%
%    \node[align=left,anchor=north west] 
%        at (\stepsize * -2.5,\lvlbase + 2.6*\lvlheight) 
%        {\textit{Contextual Sentence Embeddings}};
%
%    \draw[rectangle,draw=black,dotted] 
%        (\stepsize*-2.5,\lvlbase + 0.5*\lvlheight) -- 
%        (\stepsize*3.5, \lvlbase + 0.5*\lvlheight) -- 
%        (\stepsize*3.5, \lvlbase + -0.50*\lvlheight) --
%        (\stepsize*-2.5, \lvlbase + -0.50*\lvlheight) --
%        (\stepsize*-2.5, \lvlbase + 0.5*\lvlheight) ;
%
%    \node[align=left,anchor=north west] 
%        at (\stepsize * -2.5,\lvlbase + 0.5*\lvlheight) 
%        {\textit{Sentence Embeddings}\\\textit{(Sentence Encoder Output)}};
%
%
%    \draw[rectangle,draw=black,dotted] 
%        (\stepsize*-2.5,\lvlbase + 1.7*\lvlheight) -- 
%        (\stepsize*3.5, \lvlbase + 1.7*\lvlheight) -- 
%        (\stepsize*3.5, \lvlbase + 0.6*\lvlheight) --
%        (\stepsize*-2.5, \lvlbase + 0.6*\lvlheight) --
%        (\stepsize*-2.5, \lvlbase + 1.7*\lvlheight) ;
%
%
%    \node[align=left,anchor=north west] 
%        at (\stepsize * -2.5,\lvlbase + 1.7*\lvlheight) 
%        {\textit{Forward and Backward Partial}\\\textit{Contexual Sentence Embeddings}};


\end{tikzpicture}


\end{figure}
